<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Particles Interaction - Gesture Control</title>
    <style>
        body { margin: 0; overflow: hidden; background: #050505; font-family: 'Segoe UI', sans-serif; }
        canvas { display: block; }

        /* Giao diện điều khiển */
        #ui-container {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .control-group { margin-bottom: 10px; }
        label { display: block; font-size: 12px; margin-bottom: 5px; opacity: 0.8; }
        input[type="color"] {
            border: none; width: 40px; height: 40px; cursor: pointer; background: none;
        }

        /* Camera preview nhỏ */
        #video-container {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 160px;
            height: 120px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.3);
            transform: scaleX(-1); /* Mirror camera */
        }
        video { width: 100%; height: 100%; object-fit: cover; }

        #status {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
        }
    </style>
</head>
<body>

    <div id="ui-container">
        <h3 style="margin: 0 0 10px 0; font-size: 16px;">Hệ Thống Hạt 3D</h3>
        <div class="control-group">
            <label>Màu sắc hạt:</label>
            <input type="color" id="particleColor" value="#00ffff">
        </div>
        <div style="font-size: 11px; line-height: 1.4; opacity: 0.7;">
            • Dùng 2 tay đưa trước Camera<br>
            • Di chuyển 2 tay xa/gần nhau<br>
            để mở rộng/thu nhỏ khối cầu.
        </div>
    </div>

    <div id="status">Đang khởi tạo Camera & AI...</div>
    <div id="video-container">
        <video id="input_video"></video>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- CẤU HÌNH THREE.JS ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        camera.position.z = 5;

        // Tạo hệ thống hạt
        const particleCount = 5000;
        const positions = new Float32Array(particleCount * 3);
        const originalCoords = new Float32Array(particleCount * 3); // Lưu vị trí gốc (hình cầu đơn vị)

        for (let i = 0; i < particleCount; i++) {
            // Phân bổ các điểm ngẫu nhiên trên bề mặt hình cầu
            const phi = Math.acos(-1 + (2 * i) / particleCount);
            const theta = Math.sqrt(particleCount * Math.PI) * phi;

            const x = Math.cos(theta) * Math.sin(phi);
            const y = Math.sin(theta) * Math.sin(phi);
            const z = Math.cos(phi);

            positions[i * 3] = x;
            positions[i * 3 + 1] = y;
            positions[i * 3 + 2] = z;

            originalCoords[i * 3] = x;
            originalCoords[i * 3 + 1] = y;
            originalCoords[i * 3 + 2] = z;
        }

        const geometry = new THREE.BufferGeometry();
        geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

        const material = new THREE.PointsMaterial({
            color: 0x00ffff,
            size: 0.015,
            transparent: true,
            blending: THREE.AdditiveBlending
        });

        const particleSystem = new THREE.Points(geometry, material);
        scene.add(particleSystem);

        // --- XỬ LÝ TƯƠNG TÁC GESTURE (MEDIAPIPE) ---
        const videoElement = document.getElementById('input_video');
        const statusElement = document.getElementById('status');
        let currentScale = 1;
        let targetScale = 1;

        function onResults(results) {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length >= 2) {
                statusElement.innerText = "Đã nhận diện 2 tay: Đang điều khiển...";
                
                // Lấy vị trí trung tâm (cổ tay) của 2 bàn tay
                const hand1 = results.multiHandLandmarks[0][0];
                const hand2 = results.multiHandLandmarks[1][0];

                // Tính khoảng cách Euclidean giữa 2 tay (0.0 đến 1.0 trong không gian camera)
                const dist = Math.sqrt(
                    Math.pow(hand1.x - hand2.x, 2) +
                    Math.pow(hand1.y - hand2.y, 2)
                );

                // Map khoảng cách từ camera sang tỉ lệ giãn nở (ví dụ: từ 1 đến 4 lần)
                targetScale = 1 + dist * 5;
            } else {
                statusElement.innerText = "Hãy đưa cả 2 bàn tay vào khung hình";
                targetScale = 1; // Thu gọn về hình cầu gốc nếu không đủ 2 tay
            }
        }

        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({
            maxNumHands: 2,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        hands.onResults(onResults);

        const cam = new Camera(videoElement, {
            onFrame: async () => {
                await hands.send({ image: videoElement });
            },
            width: 640,
            height: 480
        });
        cam.start();

        // --- MÀU SẮC ---
        document.getElementById('particleColor').addEventListener('input', (e) => {
            material.color.set(e.target.value);
        });

        // --- ANIMATION LOOP ---
        function animate() {
            requestAnimationFrame(animate);

            // Nội suy (Lerp) để chuyển động mượt mà hơn
            currentScale += (targetScale - currentScale) * 0.1;

            const posAttr = geometry.attributes.position;
            for (let i = 0; i < particleCount; i++) {
                // Cập nhật vị trí hạt dựa trên tỉ lệ hiện tại
                posAttr.array[i * 3] = originalCoords[i * 3] * currentScale;
                posAttr.array[i * 3 + 1] = originalCoords[i * 3 + 1] * currentScale;
                posAttr.array[i * 3 + 2] = originalCoords[i * 3 + 2] * currentScale;
            }
            posAttr.needsUpdate = true;

            // Xoay nhẹ hệ thống hạt cho sinh động
            particleSystem.rotation.y += 0.002;
            particleSystem.rotation.x += 0.001;

            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();
    </script>
</body>
</html>
